{%- if product.media.size > 0 -%}
  {% assign video_url = '' %}
  {% assign host = '' %}
  {% assign external_id = '' %}
  {% assign is_3d_obj = '' %}
  {%- assign show_thumbnails_if_one_media = true -%}

  <div class="card">
    <div class="card__section card__section--tight">
      <div class="product-gallery {% if show_thumbnails_if_one_media %}product-gallery--with-thumbnails{% endif %}">
        {%- assign selected_media = product.selected_variant.featured_media | default: product.featured_media -%}

        <div class="product-gallery__carousel-wrapper">
          <div
            class="product-gallery__carousel {% if template != 'product.quick-view' and section.settings.enable_image_zoom %}product-gallery__carousel--zoomable{% endif %}"
            data-media-count="{{ product.media.size }}"
            data-initial-media-id="{{ selected_media.id }}"
          >
            {%- for media in product.media -%}
              {%- assign is_media_group = false -%}
              {%- assign is_media_filtered = false -%}
              {%- assign media_alt = media.alt -%}

              {%- if media.alt contains '#' -%}
                {%- assign is_media_group = true -%}
                {%- assign alt_parts = media.alt | split: '#' -%}

                {%- comment -%}
                  If the custom ALT tag contains two parts (for instance "My custom alt # color_blue") then the first part is actually used
                  as a custom ALT tag
                {%- endcomment -%}

                {%- if alt_parts.size == 2 and alt_parts.first != blank -%}
                  {%- assign media_alt = alt_parts.first | strip -%}
                {%- else -%}
                  {%- assign media_alt = product.title -%}
                {%- endif -%}

                {%- assign media_group_parts = alt_parts.last | split: '_' -%}

                {%- for option in product.options -%}
                  {%- assign downcase_option = option | downcase -%}
                  {%- assign downcase_group_option = media_group_parts.first | strip | downcase -%}

                  {%- if downcase_option == downcase_group_option -%}
                    {%- assign option_setting = 'option' | append: forloop.index -%}
                    {%- assign option_value = product.selected_or_first_available_variant[option_setting] | downcase -%}

                    {%- assign downcase_group_value = media_group_parts.last | strip | downcase -%}
                    {%- assign media_variant_ids = media.variants | map: 'id' -%}

                    {%- if option_value != downcase_group_value -%}
                      {%- unless media_variant_ids contains product.selected_or_first_available_variant.id -%}
                        {%- assign is_media_filtered = true -%}
                      {%- endunless -%}
                    {%- endif -%}

                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}

              <div
                class="product-gallery__carousel-item {% if media.id == selected_media.id %}is-selected{% endif %} {% if is_media_filtered %}is-filtered{% endif %}"
                id="st_{{ media.id }}"
                tabindex="-1"
                data-media-id="{{ media.id }}"
                data-media-type="{{ media.media_type | escape }}"
                {% if media.media_type == 'external_video' %}
                  data-media-host="{{ media.host | escape }}" data-video-id="{{ media.external_id | escape }}"
                {% endif %}
                {% if is_media_group %}
                  data-group-name="{{ media_group_parts.first | strip | downcase | escape }}"
                  data-group-value="{{ media_group_parts.last | strip | downcase | escape }}"
                {% endif %}
              >
                {%- case media.media_type -%}
                  {%- when 'image' -%}
                    <div class="product-gallery__size-limiter" style="max-width: {{ media.width }}px">
                      {%- assign data_zoom_url = media | image_url: width: 1800 -%}
                      {%- assign data_zoom_width = 1800 | at_most: media.width -%}

                      <div class="aspect-ratio" style="padding-bottom: {{ 100.0 | divided_by: media.aspect_ratio }}%">
                        {{-
                          media
                          | image_url: width: media.width
                          | image_tag:
                            loading: 'lazy',
                            widths: '400,500,600,700,800,900,1000,1100,1200',
                            class: 'product-gallery__image',
                            data-zoom: data_zoom_url,
                            data-zoom-width: data_zoom_width
                        -}}
                      </div>
                    </div>

                  {%- when 'model' -%}
                    <div class="product-gallery__model">
                      <div class="model-wrapper">
                        {% assign is_3d_obj = 'st_' | append: media.id %}
                        {{- media | model_viewer_tag: image_size: '1024x', reveal: 'interaction', toggleable: true -}}
                      </div>
                    </div>

                  {%- when 'external_video' -%}
                    <div class="product-gallery__external-video">
                      <div class="video-wrapper">
                        {% assign external_id = media.external_id %}
                        {% assign host = media.host %}
                        {{-
                          media
                          | external_video_tag: image_size: '1024x', loop: section.settings.enable_video_looping
                        -}}
                      </div>
                    </div>

                  {%- when 'video' -%}
                    <div class="product-gallery__video">
                      <div
                        class="video-wrapper video-wrapper--native"
                        style="padding-bottom: {{ 100.0 | divided_by: media.aspect_ratio }}%"
                      >
                        {% for source in media.sources %}
                          {% if source.url contains '.mp4' %}
                            {% assign video_url = source.url %}
                            {% break %}
                          {% endif %}
                        {% endfor %}

                        {{- media | video_tag: image_size: '1024x', controls: true -}}
                      </div>
                    </div>
                {%- endcase -%}
              </div>
            {%- endfor -%}
          </div>

          {%- comment -%}Add the "view in your space" button, which allows to show the product in customer's environment (if the device supports it){%- endcomment -%}
          {%- assign first_3d_model = product.media | where: 'media_type', 'model' | first -%}

          {%- if first_3d_model -%}
            <button
              class="product-gallery__view-in-space button button--full"
              data-shopify-xr
              data-shopify-model3d-id="{{ first_3d_model.id }}"
              data-shopify-model3d-default-id="{{ first_3d_model.id }}"
              data-shopify-title="{{ product.title | escape }}"
              data-shopify-xr-hidden
            >
              {%- render 'icon', icon: 'media-view-in-space' -%}
              {{- 'product.general.view_in_space' | t -}}
            </button>
          {%- endif -%}

          {%- if template != 'product.quick-view' and section.settings.enable_image_zoom -%}
            <span class="product-gallery__zoom-notice">
              {% render 'icon', icon: 'zoom' %}
              <span class="hidden-pocket">{{ 'product.general.zoom' | t }}</span>
              <span class="hidden-lap-and-up">{{ 'product.general.zoom_mobile' | t }}</span>
            </span>
          {%- endif -%}
        </div>

        {%- if show_thumbnails_if_one_media -%}
          <div class="scroller">
            <div class="scroller__inner" id="scrollable">
              <div class="product-gallery__thumbnail-list" id="scrollablecontent">
                {%- for media in product.media -%}
                  {%- assign is_media_group = false -%}
                  {%- assign is_media_filtered = false -%}
                  {%- assign media_alt = media.alt -%}

                  {%- if media.alt contains '#' -%}
                    {%- assign is_media_group = true -%}
                    {%- assign alt_parts = media.alt | split: '#' -%}

                    {%- comment -%}
                      If the custom ALT tag contains two parts (for instance "My custom alt # color_blue") then the first part is actually used
                      as a custom ALT tag
                    {%- endcomment -%}

                    {%- if alt_parts.size == 2 and alt_parts.first != blank -%}
                      {%- assign media_alt = alt_parts.first | strip -%}
                    {%- else -%}
                      {%- assign media_alt = product.title -%}
                    {%- endif -%}

                    {%- assign media_group_parts = alt_parts.last | split: '_' -%}

                    {%- for option in product.options -%}
                      {%- assign downcase_option = option | downcase -%}
                      {%- assign downcase_group_option = media_group_parts.first | strip | downcase -%}

                      {%- if downcase_option == downcase_group_option -%}
                        {%- assign option_setting = 'option' | append: forloop.index -%}
                        {%- assign option_value = product.selected_or_first_available_variant[option_setting]
                          | downcase
                        -%}

                        {%- assign downcase_group_value = media_group_parts.last | strip | downcase -%}
                        {%- assign media_variant_ids = media.variants | map: 'id' -%}

                        {%- if option_value != downcase_group_value -%}
                          {%- unless media_variant_ids contains product.selected_or_first_available_variant.id -%}
                            {%- assign is_media_filtered = true -%}
                          {%- endunless -%}
                        {%- endif -%}

                        {%- break -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}

                  <a
                    href="{{ media | img_url: '1024x' }}"
                    rel="noopener"
                    class="product-gallery__thumbnail {% if media.id == selected_media.id %}is-nav-selected{% endif %} {% if is_media_filtered %}is-filtered{% endif %}"
                    data-media-id="{{ media.id }}"
                    {% if is_media_group %}
                      data-group-name="{{ media_group_parts.first | strip | downcase | escape }}"
                      data-group-value="{{ media_group_parts.last | strip | downcase | escape }}"
                    {% endif %}
                  >
                    {%- comment -%}Based on the type of media, we have to add an icon as per Shopify rules{%- endcomment -%}

                    {%- case media.media_type -%}
                      {%- when 'model' -%}
                        <span class="product-gallery__thumbnail-badge">
                          {%- render 'icon', icon: 'media-model-badge' -%}
                        </span>

                      {%- when 'video', 'external_video' -%}
                        <span class="product-gallery__thumbnail-badge">
                          {%- render 'icon', icon: 'media-video-badge' -%}
                        </span>
                    {%- endcase -%}

                    {{-
                      media
                      | image_url: width: media.width
                      | image_tag: loading: 'lazy', sizes: '130px', widths: '130,260,390'
                    -}}
                  </a>
                {%- endfor -%}
              </div>
            </div>
            <button id="prev" style="display: none;">{%- render 'icon', icon: 'st-prev', stroke_width: 1.5 -%}</button>
            <button id="next">{%- render 'icon', icon: 'st-next', stroke_width: 1.5 -%}</button>
          </div>
        {%- endif -%}

        {%- if section.settings.enable_image_zoom -%}
          {%- comment -%}This code is used to power the mobile zoom and must not be removed nor altered{%- endcomment -%}
          <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="pswp__bg"></div>
            <div class="pswp__scroll-wrap">
              <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
              </div>

              <div class="pswp__ui">
                <button class="pswp__button pswp__button--close" aria-label="{{ 'general.accessibility.close' | t }}">
                  {% render 'icon', icon: 'close-2' %}
                </button>

                <div class="pswp__prev-next">
                  <button
                    class="pswp__button pswp__button--arrow--left"
                    aria-label="{{ 'general.accessibility.previous' | t }}"
                  >
                    {% render 'icon', icon: 'arrow-left' %}
                  </button>

                  <button
                    class="pswp__button pswp__button--arrow--right"
                    aria-label="{{ 'general.accessibility.next' | t }}"
                  >
                    {% render 'icon', icon: 'arrow-right' %}
                  </button>
                </div>

                <div class="pswp__pagination">
                  <span class="pswp__pagination-current"></span> / <span class="pswp__pagination-count"></span>
                </div>
              </div>
            </div>
          </div>
        {%- endif -%}
        <div class="video-3d-objects">
          {% if video_url != '' %}
            <a id="video" class="open-popup" href="{{ video_url }}">
              {%- render 'icon', icon: 'st-play', stroke_width: 1.5 -%}
              Watch Video</a
            >
          {% endif %}
          {% if host == 'youtube' %}
            <a
              id="video_{{ host }}"
              class="popup-external-video"
              href="https://www.youtube.com/watch?v={{ external_id }}"
            >
              {%- render 'icon', icon: 'st-play', stroke_width: 1.5 -%}
              Watch Video</a
            >
          {% endif %}
          {% if host == 'vimeo' %}
            <a id="video_{{ host }}" class="popup-external-video" href="https://vimeo.com/{{ external_id }}">
              {%- render 'icon', icon: 'st-play', stroke_width: 1.5 -%}
              Watch Video</a
            >
          {% endif %}
          {% if is_3d_obj != '' %}
            <a id="3d" class="open-popup-inline" href="#{{ is_3d_obj }}">
              {%- render 'icon', icon: 'st-360', stroke_width: 1.5 -%}
              360º View</a
            >
          {% endif %}
        </div>
      </div>
    </div>
    {%- for block in section.blocks -%}
      {%- case block.type -%}
        {%- when 'product_mail_print' -%}
          <div class="card__section card__section--tight product_mail_print hidden-tablet hidden-phone">
            <div class="button-group">
              {% if block.settings.mail %}
                {% if customer %}
                  <a
                    class="button button--small button--transparent notarget"
                    href="mailto:{{ customer.email }}?subject={{ product.title | url_encode }}&body=Product Name: {{ product.title | url_encode }}%0AProduct Link: {{ product.url | shopify_asset_url | url_encode }}"
                    target="_self"
                  >
                    {%- render 'icon', icon: block.settings.mailicon, stroke_width: 1.5 -%}
                    Mail it
                  </a>
                {% else %}
                  <a
                    class="button button--small button--transparent notarget mail"
                    href="mailto:?subject={{ product.title | url_encode }}&body=Product Name: {{ product.title | url_encode }}%0AProduct Link: {{ product.url | shopify_asset_url | url_encode }}"
                    target="_self"
                  >
                    {%- render 'icon', icon: block.settings.mailicon, stroke_width: 1.5 -%}
                    Mail it
                {% endif %}
              {% endif %}
              {% if block.settings.print %}
                <a
                  class="button button--small button--transparent notarget print"
                  href="javascript:void(0)"
                  onclick="window.print()"
                  target="_self"
                >
                  {%- render 'icon', icon: block.settings.printicon, stroke_width: 1.5 -%}
                  Print it</a
                >
              {% endif %}
              {% if block.settings.specifications %}
                {%- if product.metafields.my_fields.arctic_grey_file_metafield != blank
                  or product.metafields.my_fields.specifications_sheet != blank
                -%}
                  {% if product.metafields.my_fields.arctic_grey_file_metafield != blank %}
                    {% assign fileurl = product.metafields.my_fields.arctic_grey_file_metafield %}
                  {% else %}
                    {% assign fileurl = product.metafields.my_fields.specifications_sheet %}
                  {% endif %}
                  <a class="button button--small button--transparent tech_specifications" href="{{ fileurl | file_url }}" target="_blank">
                    {%- render 'icon', icon: block.settings.specificationsicon, stroke_width: 1.5 -%}
                    Technical Specifications</a
                  >
                {% endif %}
              {% endif %}
            </div>
            <div class="badges">
              {% if block.settings.badge != blank %}
                <img src="{{ block.settings.badge | remove: "files/" | file_url }}" alt="Badges">
              {% else %}
                <img src="{{ 'files/abc_badges.png' | remove: "files/" | file_url }}" alt="Badges">
              {% endif %}
            </div>
          </div>
      {% endcase %}
    {% endfor %}
  </div>
{%- endif -%}
